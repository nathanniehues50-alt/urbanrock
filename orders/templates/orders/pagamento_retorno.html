{% extends "base.html" %}
{% load static %}

{% block title %}Retorno do pagamento - UrbanRock{% endblock %}

{% block content %}
<div class="container py-5">

  <!-- Cabe√ßalho -->
  <div class="row mb-4">
    <div class="col-12 d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-2">
      <div>
        <h1 class="h3 mb-1">
          Retorno do pagamento
        </h1>
        <p class="mb-0 text-muted">
          Pedido <strong>#{{ pedido.id }}</strong>
        </p>
      </div>

      <div class="text-md-end">
        {% if pedido.status == "pago" %}
          <span class="badge bg-success fs-6">Pagamento confirmado ‚úÖ</span>
        {% elif pedido.status == "aguardando_pagamento" %}
          <span class="badge bg-warning text-dark fs-6">Aguardando confirma√ß√£o ‚è≥</span>
        {% elif pedido.status == "cancelado" %}
          <span class="badge bg-danger fs-6">Pagamento n√£o aprovado ‚ùå</span>
        {% else %}
          <span class="badge bg-secondary fs-6">
            {{ pedido.get_status_display|default:"Status do pagamento" }}
          </span>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="row g-4">

    <!-- Coluna principal -->
    <div class="col-lg-8 d-flex flex-column gap-4">

      <!-- Status detalhado -->
      <div class="card shadow-sm border-0">
        <div class="card-body">
          <h2 class="h5 mb-3">Status do pagamento</h2>

          {% if pedido.status == "pago" %}
            <p class="mb-2">
              üéâ <strong>Pagamento aprovado!</strong>
            </p>
            <p class="mb-0 text-muted">
              Seu pedido ser√° encaminhado para separa√ß√£o e envio. Voc√™ receber√° atualiza√ß√µes
              no e-mail cadastrado.
            </p>

          {% elif pedido.status == "aguardando_pagamento" %}
            <p class="mb-2">
              ‚è≥ <strong>Estamos aguardando a confirma√ß√£o do pagamento.</strong>
            </p>
            <p class="mb-0 text-muted">
              Dependendo da forma de pagamento, a confirma√ß√£o pode levar alguns minutos
              (cart√£o/Pix) ou at√© alguns dias √∫teis (boleto).
            </p>

          {% elif pedido.status == "cancelado" %}
            <p class="mb-2">
              ‚ùå <strong>Pagamento n√£o foi aprovado.</strong>
            </p>
            <p class="mb-0 text-muted">
              Verifique os dados do pagamento ou tente novamente com outra forma de
              pagamento.
            </p>

          {% else %}
            <p class="mb-0 text-muted">
              Status atual:
              <strong>{{ pedido.get_status_display|default:"Em processamento" }}</strong>
            </p>
          {% endif %}
        </div>
      </div>

      <!-- Endere√ßo de entrega (se dispon√≠vel) -->
      <div class="card shadow-sm border-0">
        <div class="card-body">
          <h2 class="h5 mb-3">Endere√ßo de entrega</h2>

          {% if pedido.endereco %}
            <p class="mb-0">
              {{ pedido.endereco.logradouro|default_if_none:"" }}
              {% if pedido.endereco.numero %}, {{ pedido.endereco.numero }}{% endif %}<br>
              {{ pedido.endereco.bairro|default_if_none:"" }} - {{ pedido.endereco.cidade|default_if_none:"" }}/{{ pedido.endereco.estado|default_if_none:"" }}<br>
              CEP: {{ pedido.endereco.cep|default_if_none:"" }}
            </p>
          {% else %}
            <p class="mb-0 text-muted">
              Nenhum endere√ßo de entrega dispon√≠vel para este pedido.
            </p>
          {% endif %}
        </div>
      </div>

      <!-- Itens do pedido (opcional, ajusta o related_name se for diferente) -->
      <div class="card shadow-sm border-0">
        <div class="card-body">
          <h2 class="h5 mb-3">Itens do pedido</h2>

          <div class="list-group list-group-flush">
            {% for item in pedido.itens.all %}
              <div class="list-group-item px-0 d-flex justify-content-between align-items-center">
                <div>
                  <div class="fw-semibold">{{ item.produto.nome }}</div>
                  <small class="text-muted">
                    Qtd: {{ item.quantidade }} &middot;
                    R$ {{ item.preco|floatformat:2 }}
                  </small>
                </div>
                <div class="fw-semibold">
                  R$ {{ item.subtotal|default:item.total|floatformat:2 }}
                </div>
              </div>
            {% empty %}
              <p class="mb-0 text-muted">
                Nenhum item encontrado para este pedido.
              </p>
            {% endfor %}
          </div>
        </div>
      </div>

    </div>

    <!-- Coluna lateral -->
    <div class="col-lg-4 d-flex flex-column gap-4">

      <!-- Resumo financeiro -->
      <div class="card shadow-sm border-0">
        <div class="card-body">
          <h2 class="h5 mb-3">Resumo do pedido</h2>

          <div class="d-flex justify-content-between mb-2">
            <span class="text-muted">Subtotal</span>
            <span>R$ {{ pedido.subtotal|default:total|floatformat:2 }}</span>
          </div>

          {% if pedido.desconto or desconto_valor %}
          <div class="d-flex justify-content-between mb-2">
            <span class="text-muted">Descontos</span>
            <span class="text-success">- R$ {{ pedido.desconto|default:desconto_valor|floatformat:2 }}</span>
          </div>
          {% endif %}

          {% if pedido.frete_valor or frete_valor %}
          <div class="d-flex justify-content-between mb-2">
            <span class="text-muted">Frete</span>
            <span>R$ {{ pedido.frete_valor|default:frete_valor|floatformat:2 }}</span>
          </div>
          {% endif %}

          <hr>

          <div class="d-flex justify-content-between align-items-center">
            <span class="fw-semibold">Total</span>
            <span class="fw-bold fs-5">
              R$ {{ pedido.total|default:total|floatformat:2 }}
            </span>
          </div>
        </div>
      </div>

      <!-- A√ß√µes -->
      <div class="card shadow-sm border-0">
        <div class="card-body d-grid gap-2">

          {% if pedido.status == "pago" %}
            <a href="{% url 'home' %}" class="btn btn-primary">
              Continuar comprando
            </a>

            <a href="{% url 'minha_conta' %}" class="btn btn-outline-secondary">
              Ver meus pedidos
            </a>

          {% elif pedido.status == "aguardando_pagamento" %}
            {% if link_pagamento %}
              <a href="{{ link_pagamento }}" class="btn btn-primary">
                Ver detalhes do pagamento
              </a>
            {% endif %}

            <a href="{% url 'home' %}" class="btn btn-outline-secondary">
              Voltar para a loja
            </a>

          {% elif pedido.status == "cancelado" %}
            {% if link_pagamento %}
              <a href="{{ link_pagamento }}" class="btn btn-primary">
                Tentar pagar novamente
              </a>
            {% endif %}

            <a href="{% url 'home' %}" class="btn btn-outline-secondary">
              Voltar para a loja
            </a>

          {% else %}
            <a href="{% url 'home' %}" class="btn btn-primary">
              Voltar para a loja
            </a>
          {% endif %}

        </div>
      </div>

    </div>

  </div>
</div>
{% endblock %}
